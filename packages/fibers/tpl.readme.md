<!-- include ../../assets/tpl/header.md -->

<!-- toc -->

## About

{{pkg.description}}

This package provides a
[`Fiber`](https://docs.thi.ng/umbrella/fibers/classes/Fiber.html) primitive
acting as wrapper around ES6 generators (co-routines) and supplements them with
nested child processes, cancellation, error & event handling and (optional)
logging features. Additionally, there're a number of fiber-related utilities and
higher order operators to construct and compose fibers.

### Basic usage

```ts tangle:export/readme-1.ts
import { fiber, wait } from "@thi.ng/fibers";
import { ConsoleLogger } from "@thi.ng/logger";

// wrap an endless generator as fiber
const app = fiber(
	function* () {
		while(true) {
			console.log("hello");
			// wait 0.25s
			yield* wait(250);
			console.log("fiber");
			// wait 1s
			yield* wait(1000);
		}
	}
);

// start processing it with default handlers
// see: https://docs.thi.ng/umbrella/fibers/classes/Fiber.html#run
app.run();

// hello
// <1/4 second delay>
// fiber!
// <1 second delay>
// hello
// ...

// create a child process which runs semi-independently
// (only executes if parent is still active)
// child fibers are auto-removed from parent when they terminate
const child = app.fork(
	// the `ctx` arg is the fiber wrapping this generator
	function* (ctx) {
		for(let i = 0; i < 3; i++) {
			ctx.logger?.debug("count", i);
			yield* wait(100);
		}
		// return value will be stored in fiber for future reference
		return 42;
	},
	// fiber options
	{
		// custom fiber ID (else autogenerated)
		id: "child-demo",
		// custom logger (default: none)
		logger: new ConsoleLogger("child")
	}
);

// hello
// [DEBUG] child: init child-demo
// [DEBUG] child: count 0
// [DEBUG] child: count 1
// [DEBUG] child: count 2
// fiber
// [DEBUG] child: done child-demo 42
// [DEBUG] child: deinit child-demo
// hello
// fiber
// hello
// ...

// once a fiber has completed, its value can be obtained
// e.g. here we create another fiber, which first waits for `child` to complete
app.fork(function* () {
	// wait for other fiber
	const result = yield* child;
	console.log("result", result);
	// alt way to obtain value
	console.log("deref", child.deref());
});
// result 42
// deref 42
```

### Fiber operators

The following operators act as basic composition helpers to construct more elaborate fiber setups:

- [`all`](https://docs.thi.ng/umbrella/fibers/functions/all.html): wait for all given fibers to complete
- [`first`](https://docs.thi.ng/umbrella/fibers/functions/first.html): wait for one of the given fibers to complete
- [`sequence`](https://docs.thi.ng/umbrella/fibers/functions/sequence.html): execute fibers in sequence
- [`timeSlice`](https://docs.thi.ng/umbrella/fibers/functions/timeSlice.html): execute fiber in chunks of N milliseconds
- [`until`](https://docs.thi.ng/umbrella/fibers/functions/until.html): wait until predicate is truthy
- [`untilEvent`](https://docs.thi.ng/umbrella/fibers/functions/untilEvent.html): wait until event occurs
- [`untilPromise`](https://docs.thi.ng/umbrella/fibers/functions/untilPromise.html): wait until promise resolves/rejects
- [`untilState`](https://docs.thi.ng/umbrella/fibers/functions/untilState.html): stateful version of `until`
- [`wait`](https://docs.thi.ng/umbrella/fibers/functions/wait.html): wait for N milliseconds or indefinitely
- [`waitFrames`](https://docs.thi.ng/umbrella/fibers/functions/waitFrames.html): wait for N frames/ticks
- [`withTimeout`](https://docs.thi.ng/umbrella/fibers/functions/withTimeout.html): wait for given fiber, but only max N milliseconds

### Composition via transducers

The [@thi.ng/transducers
package](https://github.com/thi-ng/umbrella/tree/develop/packages/transducers)
can be very helpful to create complex fiber setups, for example:

```ts tangle:export/readme-2.ts
import { sequence, wait, type MaybeFiber } from "@thi.ng/fibers";
import {
	cycle,
	interpose,
	map,
	partition,
	repeatedly,
} from "@thi.ng/transducers";

const defWorkItem = (id: number) =>
	function* () {
		console.log("part", id);
	};

const defWorkGroup = (items: MaybeFiber[]) =>
	function* () {
		// interject a short pause between given work items
		// then execute in order and wait until all done
		yield* sequence(interpose(() => wait(100), items));
		console.log("---");
		yield* wait(1000);
	};

// create fiber which executes given sub-processes in order
sequence(
	// generate 25 work items
	// partition into groups of 5
	// transform into iterable of work groups
	// repeat indefinitely
	cycle(map(defWorkGroup, partition(5, repeatedly(defWorkItem, 25))))
).run();

// part 0
// part 1
// part 2
// part 3
// part 4
// ---
// part 5
// part 6
// part 7
```

{{meta.status}}

{{repo.supportPackages}}

{{repo.relatedPackages}}

{{meta.blogPosts}}

## Installation

{{pkg.install}}

{{pkg.size}}

## Dependencies

{{pkg.deps}}

{{repo.examples}}

## API

{{pkg.docs}}

TODO

<!-- include ../../assets/tpl/footer.md -->
