<!-- This file is generated - DO NOT EDIT! -->

# ![@thi.ng/fibers](https://media.thi.ng/umbrella/banners-20220914/thing-fibers.svg?d08288cb)

[![npm version](https://img.shields.io/npm/v/@thi.ng/fibers.svg)](https://www.npmjs.com/package/@thi.ng/fibers)
![npm downloads](https://img.shields.io/npm/dm/@thi.ng/fibers.svg)
[![Mastodon Follow](https://img.shields.io/mastodon/follow/109331703950160316?domain=https%3A%2F%2Fmastodon.thi.ng&style=social)](https://mastodon.thi.ng/@toxi)

This project is part of the
[@thi.ng/umbrella](https://github.com/thi-ng/umbrella/) monorepo.

- [About](#about)
  - [Basic usage](#basic-usage)
  - [Fiber operators](#fiber-operators)
  - [Composition via transducers](#composition-via-transducers)
- [Status](#status)
- [Installation](#installation)
- [Dependencies](#dependencies)
- [Usage examples](#usage-examples)
- [API](#api)
- [Authors](#authors)
- [License](#license)

## About

Process hierarchies & operators for cooperative multitasking.

This package provides a
[`Fiber`](https://docs.thi.ng/umbrella/fibers/classes/Fiber.html) primitive
acting as wrapper around ES6 generators (co-routines) and supplements them with
nested child processes, cancellation, error & event handling and (optional)
logging features. Additionally, there're a number of fiber-related utilities and
higher order operators to construct and compose fibers.

### Basic usage

```ts tangle:export/readme-1.ts
import { fiber, wait } from "@thi.ng/fibers";
import { ConsoleLogger } from "@thi.ng/logger";

// wrap an endless generator as fiber
const app = fiber(
    function* () {
        while(true) {
            console.log("hello");
            // wait 0.25s
            yield* wait(250);
            console.log("fiber");
            // wait 1s
            yield* wait(1000);
        }
    }
);

// start processing it with default handlers
// see: https://docs.thi.ng/umbrella/fibers/classes/Fiber.html#run
app.run();

// create a child process which runs semi-independently
// (only executes if parent is still active)
// child fibers are auto-removed from parent when they terminate
const child = app.fork(
    // the `ctx` arg is the fiber wrapping this generator
    function* (ctx) {
        for(let i = 0; i < 3; i++) {
            ctx.logger?.debug("count", i);
            yield* wait(100);
        }
        // return value will be stored in fiber for future reference
        return 42;
    },
    // fiber options
    {
        // custom fiber ID (else autogenerated)
        id: "child-demo",
        // custom logger (default: none)
        logger: new ConsoleLogger("child")
    }
);

// hello
// [DEBUG] child: init child-demo
// [DEBUG] child: count 0
// [DEBUG] child: count 1
// [DEBUG] child: count 2
// fiber
// [DEBUG] child: done child-demo 42
// [DEBUG] child: deinit child-demo
// hello
// fiber
// hello
// ...

// once a fiber has completed, its value can be obtained
// e.g. here we create another fiber, which first waits for `child` to complete
app.fork(function* () {
    // wait for other fiber
    const result = yield* child;
    console.log("result", result);
    // alt way to obtain value
    console.log("deref", child.deref());
});
// result 42
// deref 42
```

### Fiber operators

The following operators act as basic composition helpers to construct more elaborate fiber setups:

- [`all`](https://docs.thi.ng/umbrella/fibers/functions/all.html): wait for all given fibers to complete
- [`first`](https://docs.thi.ng/umbrella/fibers/functions/first.html): wait for one of the given fibers to complete
- [`fork`](https://docs.thi.ng/umbrella/fibers/classes/Fiber.html#fork): create & attach a new child process
- [`forkAll`](https://docs.thi.ng/umbrella/fibers/classes/Fiber.html#forkAll): create & attach multiple child processes
- [`join`](https://docs.thi.ng/umbrella/fibers/classes/Fiber.html#join): wait for all child processes to complete
- [`sequence`](https://docs.thi.ng/umbrella/fibers/functions/sequence.html): execute fibers in sequence
- [`timeSlice`](https://docs.thi.ng/umbrella/fibers/functions/timeSlice.html): execute fiber in batches of N milliseconds
- [`until`](https://docs.thi.ng/umbrella/fibers/functions/until.html): wait until predicate is truthy
- [`untilEvent`](https://docs.thi.ng/umbrella/fibers/functions/untilEvent.html): wait until event occurs
- [`untilPromise`](https://docs.thi.ng/umbrella/fibers/functions/untilPromise.html): wait until promise resolves/rejects
- [`untilState`](https://docs.thi.ng/umbrella/fibers/functions/untilState.html): stateful version of `until`
- [`wait`](https://docs.thi.ng/umbrella/fibers/functions/wait.html): wait for N milliseconds or indefinitely
- [`waitFrames`](https://docs.thi.ng/umbrella/fibers/functions/waitFrames.html): wait for N frames/ticks
- [`withTimeout`](https://docs.thi.ng/umbrella/fibers/functions/withTimeout.html): wait for given fiber, but only max N milliseconds

### Composition via transducers

The [@thi.ng/transducers
package](https://github.com/thi-ng/umbrella/tree/develop/packages/transducers)
can be very helpful to create complex fiber setups, for example:

```ts tangle:export/readme-2.ts
import { sequence, wait, type MaybeFiber } from "@thi.ng/fibers";
import {
    cycle,
    interpose,
    map,
    partition,
    repeatedly,
} from "@thi.ng/transducers";

const defWorkItem = (id: number) =>
    function* () {
        console.log("part", id);
    };

const defWorkGroup = (items: MaybeFiber[]) =>
    function* () {
        // interject a short pause between given work items
        // then execute in order and wait until all done
        yield* sequence(interpose(() => wait(100), items));
        console.log("---");
        yield* wait(1000);
    };

// create fiber which executes given sub-processes in order
sequence(
    // generate 25 work items
    // partition into groups of 5
    // transform into iterable of work groups
    // repeat indefinitely
    cycle(map(defWorkGroup, partition(5, repeatedly(defWorkItem, 25))))
).run();

// part 0
// part 1
// part 2
// part 3
// part 4
// ---
// part 5
// part 6
// part 7
```

## Status

**ALPHA** - bleeding edge / work-in-progress

[Search or submit any issues for this package](https://github.com/thi-ng/umbrella/issues?q=%5Bfibers%5D+in%3Atitle)

## Installation

```bash
yarn add @thi.ng/fibers
```

ES module import:

```html
<script type="module" src="https://cdn.skypack.dev/@thi.ng/fibers"></script>
```

[Skypack documentation](https://docs.skypack.dev/)

For Node.js REPL:

```js
const fibers = await import("@thi.ng/fibers");
```

Package sizes (brotli'd, pre-treeshake): ESM: 1.88 KB

## Dependencies

- [@thi.ng/api](https://github.com/thi-ng/umbrella/tree/develop/packages/api)
- [@thi.ng/bench](https://github.com/thi-ng/umbrella/tree/develop/packages/bench)
- [@thi.ng/checks](https://github.com/thi-ng/umbrella/tree/develop/packages/checks)
- [@thi.ng/logger](https://github.com/thi-ng/umbrella/tree/develop/packages/logger)

## Usage examples

Several demos in this repo's
[/examples](https://github.com/thi-ng/umbrella/tree/develop/examples)
directory are using this package.

A selection:

| Screenshot                                                                                                          | Description                                 | Live demo                                          | Source                                                                          |
|:--------------------------------------------------------------------------------------------------------------------|:--------------------------------------------|:---------------------------------------------------|:--------------------------------------------------------------------------------|
| <img src="https://raw.githubusercontent.com/thi-ng/umbrella/develop/assets/examples/fiber-basics.png" width="240"/> | Fiber-based cooperative multitasking basics | [Demo](https://demo.thi.ng/umbrella/fiber-basics/) | [Source](https://github.com/thi-ng/umbrella/tree/develop/examples/fiber-basics) |

## API

[Generated API docs](https://docs.thi.ng/umbrella/fibers/)

TODO

## Authors

- [Karsten Schmidt](https://thi.ng)

If this project contributes to an academic publication, please cite it as:

```bibtex
@misc{thing-fibers,
  title = "@thi.ng/fibers",
  author = "Karsten Schmidt",
  note = "https://thi.ng/fibers",
  year = 2023
}
```

## License

&copy; 2023 Karsten Schmidt // Apache License 2.0
